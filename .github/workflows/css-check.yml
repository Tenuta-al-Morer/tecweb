name: W3C CSS Validator (Post-Deploy)

# Questo trigger fa partire l'azione SOLO quando il deploy di GitHub Pages ha finito
on:
  workflow_run:
    workflows: ["pages-build-deployment"] # Questo è il nome esatto preso dai tuoi log
    types:
      - completed

jobs:
  css-validation:
    runs-on: ubuntu-latest
    # Esegui solo se il deploy è andato a buon fine
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout del codice
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Installa dipendenze validatore
        run: npm install glob w3c-css-validator

      - name: Esegui Validazione URL Pubblici
        id: css-check
        continue-on-error: true 
        uses: actions/github-script@v6
        with:
          script: |
            // Importiamo le librerie (globLib per evitare conflitti di nome)
            const globLib = require('glob');
            const validator = require('w3c-css-validator');

            // 1. Definisci la base del tuo sito
            const BASE_URL = 'https://tenuta-al-morer.github.io/tecweb/';

            // 2. Troviamo i file HTML nel repository per sapere QUALI pagine testare
            //    Ignoriamo la cartella node_modules
            const files = globLib.sync('**/*.html', { ignore: 'node_modules/**' });
            
            console.log(`Trovate ${files.length} pagine nel progetto. Inizio verifica URL pubblici...`);
            
            let hasErrors = false;

            const validatePage = async (filePath) => {
              // Puliamo il percorso file per usarlo nell'URL
              // Esempio: "html\policy.html" (windows) diventa "html/policy.html"
              let cleanPath = filePath.replace(/\\/g, '/');
              
              // Se il file è index.html nella root, l'URL è pulito, altrimenti aggiungiamo il path
              // Nota: GitHub pages serve /index.html correttamente, quindi lo lasciamo.
              
              const fullUrl = BASE_URL + cleanPath;

              console.log(`ANALISI IN CORSO su: ${fullUrl}`);

              try {
                // validateUrl scarica la pagina VERA online e controlla CSS e HTML
                const result = await validator.validateUrl(fullUrl, { medium: 'all' });
                
                if (result.valid) {
                  console.log(`✅ OK: ${cleanPath}`);
                } else {
                  console.log(`❌ ERRORI su: ${cleanPath}`);
                  hasErrors = true;
                  result.errors.forEach(err => {
                    // Stampa l'errore in modo leggibile
                    console.log(`   -> Riga ${err.line}: ${err.message}`);
                  });
                }
              } catch (e) {
                console.log(`Impossibile analizzare ${fullUrl}. Errore: ${e.message}`);
              }
            };

            // Eseguiamo il ciclo su tutti i file trovati
            for (const file of files) {
              await validatePage(file);
            }

            if (hasErrors) {
              core.setFailed('Trovati errori di validazione CSS sulle pagine online.');
            } else {
              console.log("Tutte le pagine online sono valide!");
            }