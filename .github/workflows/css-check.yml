name: W3C CSS Validator (Post-Deploy)

on:
  workflow_run:
    workflows: ["pages-build-deployment"]
    types:
      - completed

jobs:
  css-validation:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout del codice
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      # Installiamo solo 'glob' perché per il W3C usiamo 'fetch' nativo
      - name: Installa dipendenze
        run: npm install glob

      - name: Esegui Validazione URL Pubblici (API Diretta)
        id: css-check
        continue-on-error: true 
        uses: actions/github-script@v6
        with:
          script: |
            const globLib = require('glob');
            
            // CONFIGURAZIONE
            const BASE_URL = 'https://tenuta-al-morer.github.io/tecweb/';
            const W3C_API = 'https://jigsaw.w3.org/css-validator/validator';

            // Troviamo i file HTML locali
            const files = globLib.sync('**/*.html', { ignore: 'node_modules/**' });
            
            console.log(`Trovate ${files.length} pagine. Inizio verifica diretta API W3C...`);
            
            let hasErrors = false;

            // Funzione helper per chiamare l'API
            const checkUrl = async (pageUrl, filePath) => {
              // Costruiamo la chiamata API: output=json, profile=css3
              const apiUrl = `${W3C_API}?uri=${encodeURIComponent(pageUrl)}&output=json&profile=css3svg&usermedium=all&warning=1&lang=it`;
              
              console.log(`Analizzo: ${pageUrl}`);

              try {
                const response = await fetch(apiUrl, {
                  headers: { 'User-Agent': 'Mozilla/5.0 (GitHub Action)' }
                });

                if (!response.ok) {
                  throw new Error(`W3C Server Error: ${response.status}`);
                }

                const data = await response.json();
                const result = data.cssvalidation;

                if (result.validity) {
                  console.log(`✅ OK: ${filePath}`);
                } else {
                  console.log(`❌ ERRORI su: ${filePath}`);
                  hasErrors = true;
                  
                  // Gestione array errori (a volte l'API cambia formato se c'è un solo errore)
                  const errors = Array.isArray(result.errors) ? result.errors : [result.errors];
                  
                  if (errors && errors.length > 0) {
                    errors.forEach(err => {
                      // Pulizia del messaggio
                      const cleanMsg = err.message ? err.message.replace(/\s+/g, ' ').trim() : 'Errore generico';
                      console.log(`   -> Riga ${err.line}: ${cleanMsg}`);
                    });
                  } else {
                     console.log(`   -> Errore generico rilevato (controlla output W3C manuale)`);
                  }
                }
              } catch (e) {
                console.log(`Errore durante la chiamata API per ${filePath}: ${e.message}`);
              }
            };

            // Eseguiamo il ciclo
            // Nota: Mettiamo un piccolo delay tra una chiamata e l'altra per educazione verso il server W3C
            const delay = ms => new Promise(res => setTimeout(res, ms));

            for (const file of files) {
              let cleanPath = file.replace(/\\/g, '/');
              const fullUrl = BASE_URL + cleanPath;
              
              await checkUrl(fullUrl, cleanPath);
              await delay(500); // Mezzo secondo di pausa tra le richieste
            }

            if (hasErrors) {
              core.setFailed('Trovati errori CSS sulle pagine online.');
            } else {
              console.log("Tutte le pagine online sono valide!");
            }