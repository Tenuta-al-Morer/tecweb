name: W3C CSS Validator

on:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  css-validation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del codice
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Installa dipendenze validatore
        run: npm install glob w3c-css-validator

      - name: Esegui Validazione CSS (Jigsaw W3C)
        id: css-check
        # continue-on-error: true assicura che il workflow continui anche se questo step fallisce
        continue-on-error: true 
        uses: actions/github-script@v6
        with:
          script: |
            const glob = require('glob');
            const validator = require('w3c-css-validator');
            const fs = require('fs');

            // Trova tutti i file HTML e CSS (root e sottocartelle)
            // Se vuoi solo html usa: '**/*.html'
            const files = glob.sync('**/*.{html,css}', { ignore: 'node_modules/**' });
            
            console.log(`üîç Trovati ${files.length} file da analizzare...`);
            
            let hasErrors = false;

            // Funzione per validare un singolo file
            const validateFile = async (file) => {
              const content = fs.readFileSync(file, 'utf8');
              try {
                const result = await validator.validateText(content, { medium: 'all' });
                
                if (result.valid) {
                  console.log(`‚úÖ ${file}: OK`);
                } else {
                  console.log(`‚ùå ${file}: ERRORI TROVATI`);
                  hasErrors = true;
                  result.errors.forEach(err => {
                    // Stampa dettaglio errore: Linea e Messaggio
                    console.log(`   -> Riga ${err.line}: ${err.message}`);
                  });
                }
              } catch (e) {
                console.log(`‚ö†Ô∏è Errore di connessione o parsing su ${file}: ${e.message}`);
              }
            };

            // Eseguiamo la validazione in serie per non sovraccaricare l'API W3C
            for (const file of files) {
              await validateFile(file);
            }

            if (hasErrors) {
              core.setFailed('Trovati errori di validazione CSS (vedi log sopra).');
            } else {
              console.log("üéâ Tutto perfetto! Nessun errore CSS trovato.");
            }